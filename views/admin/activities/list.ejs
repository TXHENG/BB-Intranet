<%- include('../partials/header.ejs') -%>
<section>
    <div class="content-wrapper">
        <div class="content-heading border-bottom row">
            <h1 class="col">Activity List</h1>
            <div class="col-lg-2 col-md-2 mt-md-2 mt-lg-2 text-right">
                <button class="btn btn-info" style="align-self: flex-end;" data-toggle="modal" data-target="#new-activity-modal">New activity</button>
            </div>
            <select name="year" id="year" class="form-control col-lg-2 col-md-2 mt-md-2 mt-lg-2 mt-sm-2">
                <%var selectedYear = locals.year ? year : moment().year() %>
                <% for(var i = moment().year(); i >= 2020; i-- ) { %>
                    <option value="<%= i %>" <%= i==moment().year()?"selected":"" %> ><%= i %></option>
                <% } %> 
            </select>
        </div>
        <div class="content-body">
            <table class="table" id="activity-list" data-filtering="true" data-sorting="true" data-paging="true" data-paging-count-format="{CP} of {TP} (total {TR} records)" data-filter-position="right">
                
            </table>
        </div>
    </div>
    <%- include('./new-modal.ejs') -%>
    <%- include('./edit-modal.ejs') -%>
</section>
<script>
    $(document).ready(async()=>{
        $('#activity-list').footable({
            columns: $.get('/admin/activities/list-col-json'),
            rows: $.get('/admin/activities/list-row-json?year=<%= selectedYear %>'),
            paging:{
                size:15,
            },
            components:{
                filtering: FooTable.MyFiltering
            }
        },()=>{

            $('#year').change(function(){
                if($(this).val().toString() != ""){
                    location.replace('/admin/activities?year='+$(this).val().toString());
                }
            });

            $('[data-toggle="tooltip"]').tooltip();

            $('[data-edit-id]').click(async function(){
                const id = $(this).data('edit-id');
                const res = await fetch('/admin/activities/'+id+'/info',{
                    method: 'get',
                    body: JSON.stringify(),
                    headers: {'Content-Type':'application/json'}
                });
                const data = await res.json();
                console.log(data);
                if(data.errors){
                    Swal.fire({
                        title: 'Error',
                        text : data.errors,
                        icon : 'error'
                    });
                } else if(data.activity){
                    console.log(data.activity._id);
                    $('#edit-activity-modal').find('#edit_activity_id').val(data.activity._id);
                    $('#edit-activity-modal').find('#edit_activity_name').val(data.activity.name);
                    $('#edit-activity-modal').find('#edit_start_date').val(moment(data.activity.startDate).format('YYYYY-MM-DD'));
                    $('#edit-activity-modal').find('#edit_end_date').val(moment(data.activity.endDate).format('YYYYY-MM-DD'));
                    $('#edit-activity-modal').find('#edit_start_date').attr('max',moment(data.activity.endDate).format('YYYYY-MM-DD'));
                    $('#edit-activity-modal').find('#edit_end_date').attr('min',moment(data.activity.startDate).format('YYYYY-MM-DD'));
                    $('#edit-activity-modal').modal();
                }
            });

            $('[data-delete-id]').click(function(){
                const id = $(this).attr("data-delete-id");
                Swal.fire({
                    title: "Are you sure",
                    text: "Do you want to delete this activity permanently?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: 'Delete',
                    cancelButtonText: 'Cancel',
                }).then(async(result)=>{
                    if(result.isConfirmed){
                        const url = '/admin/activities/'+id+'/delete';
                        try{
                            const res = await fetch(url,{
                                method:'POST',
                                body: JSON.stringify(),
                                headers: {'Content-Type':'application/json'}
                            });
                            const data = await res.json();
                            console.log(data);
                            if(data.errors){
                                Swal.fire({
                                    title: 'Error',
                                    text : data.errors,
                                    icon : 'error'
                                });
                            } else if (data.name) {
                                Swal.fire({
                                    title: 'Successfully',
                                    text : 'Activity "'+data.name+'" has been deleted successfully',
                                    icon : 'success'
                                }).then(()=>{location.reload();});
                            }
                        }
                        catch(err){}
                    }
                })
            });
        });
    });
</script>
<%- include('../partials/footer.ejs') -%>